#  【星球专享】手把手复现 Apache Airflow 漏洞指南-(CVE-2022–40604)  
原创 骨哥说事  骨哥说事   2025-07-03 03:17  
  
<table><tbody><tr><td data-colwidth="557" width="557" valign="top" style="word-break: break-all;"><h1 data-selectable-paragraph="" style="white-space: normal;outline: 0px;max-width: 100%;font-family: -apple-system, system-ui, &#34;Helvetica Neue&#34;, &#34;PingFang SC&#34;, &#34;Hiragino Sans GB&#34;, &#34;Microsoft YaHei UI&#34;, &#34;Microsoft YaHei&#34;, Arial, sans-serif;letter-spacing: 0.544px;background-color: rgb(255, 255, 255);box-sizing: border-box !important;overflow-wrap: break-word !important;"><strong style="outline: 0px;max-width: 100%;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="outline: 0px;max-width: 100%;font-size: 18px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-size: 15px;"><span leaf="">声明：</span></span></strong></span><span style="font-size: 15px;"></span></span></strong><span style="outline: 0px;max-width: 100%;font-size: 18px;box-sizing: border-box !important;overflow-wrap: break-word !important;"><span style="font-size: 15px;"><span leaf="">文章中涉及的程序(方法)可能带有攻击性，仅供安全研究与教学之用，读者将其信息做其他用途，由用户承担全部法律及连带责任，文章作者不承担任何法律及连带责任。</span></span></span></h1></td></tr></tbody></table>#   
  
#   
  
****# 防走失：https://gugesay.com/  
  
******不想错过任何消息？设置星标****↓ ↓ ↓**  
****  
#   
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/hZj512NN8jlbXyV4tJfwXpicwdZ2gTB6XtwoqRvbaCy3UgU1Upgn094oibelRBGyMs5GgicFKNkW1f62QPCwGwKxA/640?wx_fmt=png&from=appmsg "")  
  
#   
# 漏洞介绍  
  
Apache Airflow 是一个用于编排复杂工作流的开放源代码平台，广泛用于数据管道和任务调度。  
  
CVE-2022–40604 漏洞源于 src/airflow/utils/log/file_task_handler.py  
 中日志 URL 构建中的字符串格式化不当。  
  
具体来说， log_relative_path  
 变量包含了用户控制的 run_id  
 ，不安全地传递给了 .format()  
 调用，使攻击者能够注入恶意格式字符串并提取敏感配置数据。  
# 为什么格式化字符串很重要  
  
格式化字符串漏洞发生在用户输入未经适当清理就直接被包含在字符串格式化函数中（例如 Python 的 .format()  
 或 C 的 printf  
 ）。  
  
在 Airflow 的情况下，攻击者可以通过 run_id  
 参数控制 log_relative_path  
 的部分内容，从而允许他们构建格式化字符串 {ti.task.__class__.__init__.__globals__[conf].__dict__}  
 来访问内部配置对象。  
# 测试环境搭建  
## Docker 搭建  
  
docker run -p 8080:8080 apache/airflow:2.3.4  
## pip 安装方式  
```
pip install apache-airflow==2.3.4  airflow db init  airflow webserver -p 8080
```  
# 漏洞复现  
  
该漏洞存在于 Airflow 任务处理器的日志机制中。 file_task_handler.py  
 中的恶意代码为：  
```
url = os.path.join("http://{ti.hostname}:{worker_log_server_port}/log", log_relative_path).format(  ti=ti, worker_log_server_port=conf.get('logging', 'WORKER_LOG_SERVER_PORT')  )
```  
  
这里的 log_relative_path  
 包含了用户控制的 run_id  
 ，从而受到格式字符串注入攻击。  
## 复现过程  
1. 访问 DAGs 菜单：  
  
1. 登录 Airflow 的 Web 界面，例如 ：http://localhost:8080  
  
1. 导航至 DAGs 并选择一个 DAG（例如： example_xcom  
 ）  
  
1. 查看日志 URL：  
  
1. 触发一个 DAG，查看日志（Log）选项卡中的任务  
  
1. 捕获 /get_logs_with_metadata  
 的请求  
  
1. 示例 URL：  
  
```
/get_logs_with_metadata?dag_id=example_xcom&task_id=push_by_returning&map_index=-1&execution_date=2022-08-29T13:25:11+00:00&try_number=1&metadata=null
```  
1. 识别用户控制输入：  
  
1. 触发 DAG 时设置的 run_id  
 参数会影响 log_relative_path  
  
1. 测试 run_id  
 是否可以操纵格式化的 URL  
  
### 漏洞利用  
  
- 加入星球，畅享阅读 -  
  
**********（会员统一定价）：128元/年（0.35元/天）******  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/hZj512NN8jnMJtHJnShkTnh3vR3fmaqicPicANic6OEsobrpRjx5vG6mMTib1icuPmuG74h2bxC4eP6nMMzbs5QaSlw/640?wx_fmt=jpeg&from=appmsg "")  
  
**感谢阅读，如果觉得还不错的话，欢迎分享给更多喜爱的朋友～**  
  
